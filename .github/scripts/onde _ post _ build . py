#!/usr/bin/env python3
# .github/scripts/onde_post_build.py
import sys, json, os, datetime

run = sys.argv[1] if len(sys.argv)>1 else "manual"
out = os.path.join(os.path.abspath(os.path.dirname(__file__)), "..", "..", "frontend", "deploy-manifest.json")
os.makedirs(os.path.dirname(out), exist_ok=True)

manifest = {
    "deployed_at": datetime.datetime.utcnow().isoformat()+"Z",
    "run": run,
    "backend_image": f"ghcr.io/{os.getenv('GITHUB_REPOSITORY','repo')}-backend:phase4-{run}",
    "frontend_bundle": "frontend/dist (if present)",
    "status": "rolled_out_simulation"
}
with open(out, "w", encoding="utf-8") as f:
    json.dump(manifest, f, indent=2)
print("ONDE: wrote deploy-manifest.json")
