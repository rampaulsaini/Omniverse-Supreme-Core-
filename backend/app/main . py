from fastapi import FastAPI, Request, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from starlette.middleware import Middleware
from starlette.middleware.trustedhost import TrustedHostMiddleware
import uvicorn
import os
import hashlib, hmac

app = FastAPI(title="Omniverse-Supreme API")

# Trusted hosts (restrict to your domain + GitHub Pages for static)
app.add_middleware(TrustedHostMiddleware, allowed_hosts=["*"])  # Replace * with actual hostnames later.

# CORS - restrict origins (update with your domain)
origins = [
    "https://your-omni-domain.com",
    "https://rampaulsaini.github.io"
]
app.add_middleware(
    CORSMiddleware,
    allow_origins=origins, 
    allow_credentials=True,
    allow_methods=["GET","POST","OPTIONS"],
    allow_headers=["*"],
)

# Simple request signature validation (tamper protection)
API_SECRET = os.environ.get("API_SECRET", "change_this_in_env")

@app.middleware("http")
async def verify_signature(request: Request, call_next):
    # Allow health check
    if request.url.path.startswith("/health"):
        return await call_next(request)
    signature = request.headers.get("X-Omni-Signature")
    if not signature:
        raise HTTPException(status_code=401, detail="Missing signature")
    body = await request.body()
    expected = hmac.new(API_SECRET.encode(), body, digestmod=hashlib.sha256).hexdigest()
    if not hmac.compare_digest(expected, signature):
        raise HTTPException(status_code=401, detail="Invalid signature")
    return await call_next(request)

@app.get("/health")
async def health():
    return {"status":"ok","name":"Omniverse-Supreme-API"}

if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=8000)
