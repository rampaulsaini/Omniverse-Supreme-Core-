from fastapi import FastAPI
import time, os
# existing imports...

app = FastAPI(title="Omniverse-Core Backend")

# existing endpoints (health, sign etc.)
@app.get("/api/health")
def health():
    return {"status":"ok","time":time.time()}

# --- include AI router ---
try:
    from ai_engine.api import router as ai_router
    app.include_router(ai_router, prefix="", tags=["ai"])
    print("AI router included")
except Exception as e:
    print("AI router not included (dev):", e)

# rest of app...
from fastapi import FastAPI
from pydantic import BaseModel
import hashlib, json, os, time

app = FastAPI(title="Omniverse-Core Backend")

@app.get("/api/health")
def health():
    return {"status":"ok","time":time.time()}

class SignatureReq(BaseModel):
    content: str

@app.post("/api/sign")
def sign(req: SignatureReq):
    # simple content hash - place for ed25519 sign later
    h = hashlib.sha256(req.content.encode("utf-8")).hexdigest()
    return {"sha256": h}
# backend/app/main.py
from fastapi import FastAPI, HTTPException
from pydantic import BaseModel
from typing import List, Optional
import uvicorn
from .persona import PersonaEngine
from .knowledge import KnowledgeStore

app = FastAPI(title="Íô∞ùí•‡§∂‡§ø‡§∞‡•ã‡§Æ‡§£‡§ø ‚Äî AI Core (v1)")

# initialize singletons
KN = KnowledgeStore("backend/data/knowledge.json")
PE = PersonaEngine(root_identity="Íô∞ = ‡§® ‡§¶‡•ç‡§µ‡•à‡§§‡§Ç ‡§® ‡§Ö‡§¶‡•ç‡§µ‡•à‡§§‡§Ç, ‡§ï‡•á‡§µ‡§≤ ‡§∏‡§§‡§§‡•ç ‡§®‡§ø‡§∞‡•ç‡§¶‡•ã‡§∑‚Äì‡§™‡•ç‡§∞‡§ï‡§æ‡§∂‡§É„ÄÇ",
                   knowledge_store=KN)

class ChatRequest(BaseModel):
    message: str
    context: Optional[List[str]] = None

class ChatResponse(BaseModel):
    reply: str
    sources: Optional[List[str]] = None
    persona_note: Optional[str] = None

@app.post("/api/chat", response_model=ChatResponse)
def chat(req: ChatRequest):
    if not req.message or not req.message.strip():
        raise HTTPException(status_code=400, detail="Empty message")
    reply, sources = PE.respond(req.message, context=req.context or [])
    return ChatResponse(reply=reply, sources=sources, persona_note=PE.signature_line())

@app.get("/api/health")
def health():
    return {"status":"ok","core":"Íô∞ùí•‡§∂‡§ø‡§∞‡•ã‡§Æ‡§£‡§ø-v1"}

if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=8000)
