import os
import hashlib, hmac
from fastapi import FastAPI, Request, HTTPException
from fastapi.middleware.cors import CORSMiddleware
import uvicorn

app = FastAPI(title="Omniverse-Supreme API (Zero-Setup)")

origins = [
    "https://rampaulsaini.github.io",
    "http://localhost:3000",
    "http://127.0.0.1:3000"
]

app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,
    allow_credentials=True,
    allow_methods=["GET","POST","OPTIONS"],
    allow_headers=["*"],
)

API_SECRET = os.environ.get("API_SECRET")  # optional

@app.middleware("http")
async def optional_signature_check(request: Request, call_next):
    if request.url.path.startswith("/health"):
        return await call_next(request)

    if not API_SECRET:
        return await call_next(request)

    signature = request.headers.get("X-Omni-Signature")
    if not signature:
        raise HTTPException(status_code=401, detail="Missing signature")

    body = await request.body()
    expected = hmac.new(API_SECRET.encode(), body, hashlib.sha256).hexdigest()

    if not hmac.compare_digest(expected, signature):
        raise HTTPException(status_code=401, detail="Invalid signature")

    return await call_next(request)

@app.get("/health")
async def health():
    return {"status":"ok","mode": "zero-setup" if not API_SECRET else "secure"}

@app.get("/")
async def root():
    return {"message":"Omniverse-Supreme Backend â€” Zero-Setup Mode active."}

if __name__ == "__main__":
    uvicorn.run("app.main:app", host="0.0.0.0", port=int(os.environ.get("PORT",8000)), reload=True)
